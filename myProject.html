<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Project Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .card-container {
            min-height: 500px;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">

    <!-- Main UI -->
    <header class="bg-white shadow-sm py-4 px-6 flex items-center justify-between z-10 sticky top-0">
        <div class="flex items-center space-x-4">
            <h1 class="text-2xl font-bold text-gray-800">Project Board</h1>
            <div id="project-selector" class="flex items-center space-x-2"></div>
        </div>
        <button onclick="showProjectModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
            + New Project
        </button>
    </header>

    <main id="app-container" class="flex-1 overflow-auto p-6">
        <div class="flex flex-col items-center justify-center p-8 bg-white rounded-lg shadow-md text-center">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Welcome!</h2>
            <p class="text-gray-600">Please create a new project to get started.</p>
            <p class="text-gray-500 text-sm mt-2">Note: This version is local-only and does not share data between users.</p>
            <button onclick="showProjectModal()" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
                Create Your First Project
            </button>
        </div>
    </main>

    <!-- Modals and Toast -->
    <div id="modals-container"></div>
    <div id="toast-container" class="fixed bottom-4 left-1/2 -translate-x-1/2"></div>

    <script>
        const STORAGE_KEY_PROJECTS = 'trello_projects';
        const STORAGE_KEY_SELECTED_PROJECT = 'trello_selected_project';
        const STORAGE_KEY_TASKS = 'trello_tasks_';

        const state = {
            projects: [],
            selectedProjectId: null,
            tasks: [],
            showProjectModal: false,
            showTaskModal: false,
            showCommentsModal: false,
            editingTask: null,
            message: '',
            messageType: 'info'
        };

        const renderUI = () => {
            const appContainer = document.getElementById('app-container');
            const projectSelector = document.getElementById('project-selector');
            const modalsContainer = document.getElementById('modals-container');
            const toastContainer = document.getElementById('toast-container');

            // Render Projects
            projectSelector.innerHTML = state.projects.map(p => `
                <button onclick="selectProject('${p.id}')"
                    class="px-4 py-2 rounded-lg text-sm font-medium ${state.selectedProjectId === p.id ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-gray-200'}"
                >
                    ${p.name}
                </button>
            `).join('');

            // Render Main Content
            if (state.selectedProjectId) {
                const todoTasks = state.tasks.filter(t => t.status === 'todo');
                const inProgressTasks = state.tasks.filter(t => t.status === 'in-progress');
                const doneTasks = state.tasks.filter(t => t.status === 'done');

                const renderTasks = (tasks, status) => tasks.map(task => `
                    <div class="bg-white p-4 rounded-lg shadow-sm mb-4 border border-gray-200 flex flex-col">
                        <h3 class="font-bold text-gray-800 text-lg">${task.title}</h3>
                        <p class="text-gray-600 text-sm mt-1">${task.description}</p>
                        <div class="mt-3 flex flex-wrap gap-2 text-xs text-gray-500">
                            ${task.assignee ? `<span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">Assigned: ${task.assignee}</span>` : ''}
                        </div>
                        <div class="mt-4 flex flex-col gap-2">
                            <button onclick="showCommentsModal('${task.id}')" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-md text-sm hover:bg-gray-200 transition-colors duration-200">
                                Comments (${task.comments ? task.comments.length : 0})
                            </button>
                            <div class="flex gap-2">
                                ${status !== 'todo' ? `<button onclick="updateTaskStatus('${task.id}', 'todo')" class="flex-1 px-3 py-1 bg-red-500 text-white rounded-md text-sm hover:bg-red-600 transition-colors duration-200">
                                    To Do
                                </button>` : ''}
                                ${status !== 'in-progress' ? `<button onclick="updateTaskStatus('${task.id}', 'in-progress')" class="flex-1 px-3 py-1 bg-yellow-500 text-white rounded-md text-sm hover:bg-yellow-600 transition-colors duration-200">
                                    In Progress
                                </button>` : ''}
                                ${status !== 'done' ? `<button onclick="updateTaskStatus('${task.id}', 'done')" class="flex-1 px-3 py-1 bg-green-500 text-white rounded-md text-sm hover:bg-green-600 transition-colors duration-200">
                                    Done
                                </button>` : ''}
                            </div>
                            <button onclick="deleteTask('${task.id}')" class="px-3 py-1 bg-red-200 text-red-800 rounded-md text-sm hover:bg-red-300 transition-colors duration-200">
                                Delete Task
                            </button>
                        </div>
                    </div>
                `).join('');

                appContainer.innerHTML = `
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold text-gray-800">${state.projects.find(p => p.id === state.selectedProjectId).name} Board</h2>
                        <button onclick="showTaskModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200">
                            + Add Task
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- To Do Column -->
                        <div class="bg-gray-200 p-4 rounded-lg shadow-inner flex flex-col">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-bold text-gray-700 text-xl">To Do</h3>
                                <span class="bg-gray-300 text-gray-600 text-xs font-bold px-2 py-1 rounded-full">${todoTasks.length}</span>
                            </div>
                            <div class="overflow-y-auto card-container">
                                ${renderTasks(todoTasks, 'todo')}
                            </div>
                        </div>
                        <!-- In Progress Column -->
                        <div class="bg-gray-200 p-4 rounded-lg shadow-inner flex flex-col">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-bold text-gray-700 text-xl">In Progress</h3>
                                <span class="bg-gray-300 text-gray-600 text-xs font-bold px-2 py-1 rounded-full">${inProgressTasks.length}</span>
                            </div>
                            <div class="overflow-y-auto card-container">
                                ${renderTasks(inProgressTasks, 'in-progress')}
                            </div>
                        </div>
                        <!-- Done Column -->
                        <div class="bg-gray-200 p-4 rounded-lg shadow-inner flex flex-col">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-bold text-gray-700 text-xl">Done</h3>
                                <span class="bg-gray-300 text-gray-600 text-xs font-bold px-2 py-1 rounded-full">${doneTasks.length}</span>
                            </div>
                            <div class="overflow-y-auto card-container">
                                ${renderTasks(doneTasks, 'done')}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                appContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center p-8 bg-white rounded-lg shadow-md text-center">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Welcome!</h2>
                        <p class="text-gray-600">Please create a new project to get started.</p>
                        <p class="text-gray-500 text-sm mt-2">Note: This version is local-only and does not share data between users.</p>
                        <button onclick="showProjectModal()" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
                            Create Your First Project
                        </button>
                    </div>
                `;
            }

            // Render Modals
            modalsContainer.innerHTML = `
                ${state.showProjectModal ? `
                    <div class="modal-overlay fixed inset-0 flex items-center justify-center z-50">
                        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full">
                            <h2 class="text-2xl font-bold mb-4 text-gray-800">Create New Project</h2>
                            <form onsubmit="event.preventDefault(); addProject(this.projectName.value); closeModals();">
                                <input type="text" name="projectName" placeholder="Enter project name" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <div class="flex justify-end mt-4 space-x-2">
                                    <button type="button" onclick="closeModals()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors duration-200">
                                        Cancel
                                    </button>
                                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                                        Create
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                ` : ''}
                ${state.showTaskModal ? `
                    <div class="modal-overlay fixed inset-0 flex items-center justify-center z-50">
                        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full">
                            <h2 class="text-2xl font-bold mb-4 text-gray-800">Add New Task</h2>
                            <form onsubmit="event.preventDefault(); addTask({ title: this.title.value, description: this.description.value, assignee: this.assignee.value });">
                                <div class="mb-4">
                                    <label for="task-title" class="block text-gray-700 font-semibold mb-1">Title</label>
                                    <input type="text" id="task-title" name="title" placeholder="Task title" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="mb-4">
                                    <label for="task-description" class="block text-gray-700 font-semibold mb-1">Description</label>
                                    <textarea id="task-description" name="description" placeholder="Task description" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                                <div class="mb-4">
                                    <label for="task-assignee" class="block text-gray-700 font-semibold mb-1">Assignee</label>
                                    <input type="text" id="task-assignee" name="assignee" placeholder="Assignee's name (optional)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="flex justify-end mt-4 space-x-2">
                                    <button type="button" onclick="closeModals()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors duration-200">
                                        Cancel
                                    </button>
                                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200">
                                        Add Task
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                ` : ''}
                ${state.showCommentsModal && state.editingTask ? `
                    <div class="modal-overlay fixed inset-0 flex items-center justify-center z-50">
                        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-xl w-full">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-2xl font-bold text-gray-800">Comments for "${state.editingTask.title}"</h2>
                                <button type="button" onclick="closeModals()" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <div class="h-80 overflow-y-auto border border-gray-300 rounded-lg p-4 mb-4 bg-gray-50 space-y-4">
                                ${state.editingTask.comments && state.editingTask.comments.length > 0 ?
                                    state.editingTask.comments.map(comment => `
                                        <div class="bg-gray-100 p-3 rounded-lg shadow-sm">
                                            <div class="text-sm font-semibold text-gray-800">You</div>
                                            <p class="text-gray-700 mt-1">${comment.text}</p>
                                        </div>
                                    `).join('')
                                : `<div class="text-center text-gray-500">No comments yet.</div>`}
                            </div>
                            <form onsubmit="event.preventDefault(); addComment('${state.editingTask.id}', this.commentText.value); this.commentText.value = '';">
                                <textarea name="commentText" placeholder="Add a comment..." rows="2" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                <div class="flex justify-end mt-2">
                                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                                        Post Comment
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                ` : ''}
            `;

            // Render Toast
            toastContainer.innerHTML = state.message ? `
                <div class="px-6 py-3 rounded-lg text-white font-semibold shadow-xl transition-all duration-300 ${state.messageType === 'success' ? 'bg-green-500' : 'bg-red-500'}">
                    ${state.message}
                </div>
            ` : '';
        };

        const saveState = () => {
            localStorage.setItem(STORAGE_KEY_PROJECTS, JSON.stringify(state.projects));
            if (state.selectedProjectId) {
                localStorage.setItem(STORAGE_KEY_SELECTED_PROJECT, state.selectedProjectId);
                localStorage.setItem(STORAGE_KEY_TASKS + state.selectedProjectId, JSON.stringify(state.tasks));
            }
        };

        const loadState = () => {
            const projects = localStorage.getItem(STORAGE_KEY_PROJECTS);
            if (projects) {
                state.projects = JSON.parse(projects);
            }
            const selectedProjectId = localStorage.getItem(STORAGE_KEY_SELECTED_PROJECT);
            if (selectedProjectId) {
                selectProject(selectedProjectId);
            }
            renderUI();
        };

        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);

        window.addProject = (projectName) => {
            if (!projectName) return;
            const newProject = { id: generateId(), name: projectName };
            state.projects.push(newProject);
            saveState();
            selectProject(newProject.id);
            state.message = 'Project created!';
            state.messageType = 'success';
            renderUI();
            setTimeout(() => { state.message = ''; renderUI(); }, 3000);
        };

        window.selectProject = (projectId) => {
            state.selectedProjectId = projectId;
            const tasks = localStorage.getItem(STORAGE_KEY_TASKS + projectId);
            state.tasks = tasks ? JSON.parse(tasks) : [];
            saveState();
            renderUI();
        };

        window.addTask = (taskData) => {
            if (!state.selectedProjectId) return;
            const newTask = {
                id: generateId(),
                status: 'todo',
                comments: [],
                ...taskData,
            };
            state.tasks.push(newTask);
            saveState();
            state.message = 'Task added!';
            state.messageType = 'success';
            closeModals();
            setTimeout(() => { state.message = ''; renderUI(); }, 3000);
        };

        window.updateTaskStatus = (taskId, newStatus) => {
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                task.status = newStatus;
                saveState();
                state.message = 'Task moved!';
                state.messageType = 'success';
                renderUI();
                setTimeout(() => { state.message = ''; renderUI(); }, 3000);
            }
        };

        window.addComment = (taskId, commentText) => {
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                if (!task.comments) task.comments = [];
                task.comments.push({ text: commentText });
                saveState();
                state.message = 'Comment added!';
                state.messageType = 'success';
                renderUI();
                setTimeout(() => { state.message = ''; renderUI(); }, 3000);
            }
        };

        window.deleteTask = (taskId) => {
            state.tasks = state.tasks.filter(t => t.id !== taskId);
            saveState();
            state.message = 'Task deleted!';
            state.messageType = 'success';
            renderUI();
            setTimeout(() => { state.message = ''; renderUI(); }, 3000);
        };

        window.showProjectModal = () => {
            state.showProjectModal = true;
            renderUI();
        };

        window.showTaskModal = () => {
            state.showTaskModal = true;
            renderUI();
        };

        window.showCommentsModal = (taskId) => {
            state.editingTask = state.tasks.find(t => t.id === taskId);
            state.showCommentsModal = true;
            renderUI();
        };

        window.closeModals = () => {
            state.showProjectModal = false;
            state.showTaskModal = false;
            state.showCommentsModal = false;
            state.editingTask = null;
            renderUI();
        };

        window.onload = loadState;
    </script>
</body>
</html>
